// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://cpkhdwugpnedkdaehvve.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwa2hkd3VncG5lZGtkYWVodnZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNTI1MDksImV4cCI6MjA4MzkyODUwOX0.2w6m1wWbUWQVT3aG02klvJnJE9ekP3_990m43zuYs7E";

const GUEST_SESSION_KEY = 'kindred-cards-guest-session';

// Get guest session ID for unauthenticated users
const getGuestSessionId = (): string | null => {
  if (typeof localStorage === 'undefined') return null;
  return localStorage.getItem(GUEST_SESSION_KEY);
};

// Custom fetch that adds guest session header for RLS policies
const customFetch = (input: RequestInfo | URL, init?: RequestInit): Promise<Response> => {
  const guestSessionId = getGuestSessionId();

  // No guest session or no init - pass through unchanged
  if (!guestSessionId || !init) {
    return fetch(input, init);
  }

  // Only add guest header for REST API calls (not storage or edge functions)
  const url = typeof input === 'string' ? input : input instanceof URL ? input.href : input.url;
  if (url.includes('/functions/v1/') || url.includes('/storage/v1/')) {
    return fetch(input, init);
  }

  // Add guest session header to all REST API calls
  // RLS policies will use auth.uid() if user is authenticated, or fall back to this header
  // Always use Headers object for consistent handling
  const headers = new Headers();

  // Copy existing headers
  if (init.headers) {
    if (init.headers instanceof Headers) {
      init.headers.forEach((value, key) => {
        headers.set(key, value);
      });
    } else if (Array.isArray(init.headers)) {
      init.headers.forEach(([key, value]) => {
        headers.set(key, value);
      });
    } else if (typeof init.headers === 'object') {
      Object.entries(init.headers).forEach(([key, value]) => {
        headers.set(key, value);
      });
    }
  }

  // Add guest session header
  headers.set('x-guest-session-id', guestSessionId);

  console.log('ðŸ”‘ customFetch: Adding guest session header:', guestSessionId, '| Auth:', headers.get('Authorization')?.substring(0, 20) || 'none');
  return fetch(input, { ...init, headers });
};

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
  },
  global: {
    fetch: customFetch,
  },
});